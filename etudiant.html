<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Portefeuille Etudiant</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f3e5f5; }
        .nav { background: #333; padding: 10px; border-radius: 5px; text-align: center; margin-bottom: 20px; }
        .nav a { color: white; text-decoration: none; margin: 0 15px; font-weight: bold; }
        .nav a:hover { text-decoration: underline; color: #ddd; }

        .card { background: white; padding: 20px; border-radius: 10px; border-left: 5px solid #9c27b0; }
        button { width: 100%; padding: 12px; background-color: #9c27b0; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
</head>
<body>
    <div class="nav">
        <a href="index.html">Admin</a> |
        <a href="ecole.html">Ecole</a> |
        <a href="etudiant.html">Etudiant</a> |
        <a href="entreprise.html">Verificateur</a>
    </div>

    <h1>Mon Portefeuille</h1>
    
    <div class="card">
        <h3>1. Importer mon Diplome (JSON)</h3>
        <input type="file" id="jsonFile" accept=".json">
        <div id="fileData" style="margin-top:10px; font-weight:bold;"></div>
    </div>

    <div class="card" style="margin-top:20px;">
        <h3>2. Generer une Preuve Temporaire</h3>
        <select id="duration" style="width:100%;padding:10px;margin:10px 0;">
            <option value="60">1 Minute</option>
            <option value="3600">1 Heure</option>
        </select>
        <button onclick="createProof()">Creer Token d'Acces</button>
        <p id="tempTokenDisplay" style="font-size:1.2em; color:green; text-align:center; font-weight:bold; margin-top:15px; word-break:break-all;"></p>
    </div>

    <script>
        const contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; // ⚠️ A REMPLACER
        const abi = ["function createTempAccess(bytes32, uint256) public returns (bytes32)", "event AccessGranted(bytes32 indexed tempToken, uint256 expiration)"];
        let loadedVC = null;

        document.getElementById('jsonFile').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    loadedVC = JSON.parse(event.target.result);
                    document.getElementById('fileData').innerText = `Diplome charge : ${loadedVC.credentialSubject.degree}`;
                } catch(e) { alert("Fichier invalide"); }
            };
            reader.readAsText(e.target.files[0]);
        });

        async function createProof() {
            if(!loadedVC) return alert("Chargez le JSON d'abord !");
            
            try {
                const provider = new ethers.JsonRpcProvider("http://127.0.0.1:8545/", undefined, { staticNetwork: true });
                const signer = await provider.getSigner(10); 
                const contract = new ethers.Contract(contractAddress, abi, signer);

                const duration = document.getElementById("duration").value;
                alert("Creation du token sur la blockchain...");
                const tx = await contract.createTempAccess(loadedVC.proof.hash, duration);
                const receipt = await tx.wait();

                let token = null;
                for(const log of receipt.logs) {
                    try { 
                        const parsed = contract.interface.parseLog(log);
                        if(parsed.name === "AccessGranted") token = parsed.args[0]; 
                    } catch(e){}
                }
                
                document.getElementById("tempTokenDisplay").innerHTML = `TOKEN :<br>${token}`;

            } catch(e) { console.error(e); alert("Erreur Blockchain"); }
        }
    </script>
</body>
</html>