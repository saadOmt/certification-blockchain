<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Portefeuille Etudiant</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f3e5f5; }
        .nav { background: #333; padding: 10px; border-radius: 5px; text-align: center; margin-bottom: 20px; }
        .nav a { color: white; text-decoration: none; margin: 0 15px; font-weight: bold; }
        .nav a:hover { text-decoration: underline; color: #ddd; }

        .card { background: white; padding: 20px; border-radius: 10px; border-left: 5px solid #9c27b0; }
        button { width: 100%; padding: 12px; background-color: #9c27b0; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .token-box { word-break: break-all; background: #e1bee7; padding: 10px; border-radius: 5px; margin-top: 10px; font-family: monospace; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
</head>
<body>
    <div class="nav">
        <a href="index.html">Admin</a> |
        <a href="ecole.html">Ecole</a> |
        <a href="etudiant.html">Etudiant</a> |
        <a href="entreprise.html">Verificateur</a>
    </div>

    <h1>Mon Portefeuille</h1>
    
    <div class="card">
        <h3>1. Importer mon Diplome (JSON)</h3>
        <input type="file" id="jsonFile" accept=".json">
        <div id="fileData" style="margin-top:10px; font-weight:bold;"></div>
    </div>

    <div class="card" style="margin-top:20px;">
        <h3>2. Generer une Preuve de Presentation</h3>
        <p>Cree un lien securise contenant votre identite et la preuve blockchain.</p>
        <select id="duration" style="width:100%;padding:10px;margin:10px 0;">
            <option value="60">1 Minute</option>
            <option value="3600">1 Heure</option>
        </select>
        <button onclick="createProof()">Generer la Presentation</button>
        
        <div id="resultArea" style="display:none;">
            <p><strong>COPIEZ CE CODE POUR LE RECRUTEUR :</strong></p>
            <div id="tempTokenDisplay" class="token-box"></div>
        </div>
    </div>

    <script>
        const contractAddress = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"; 
        const abi = ["function createTempAccess(bytes32, uint256) public returns (bytes32)", "event AccessGranted(bytes32 indexed tempToken, uint256 expiration)"];
        let loadedVC = null;

        document.getElementById('jsonFile').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    loadedVC = JSON.parse(event.target.result);
                    document.getElementById('fileData').innerText = `Diplome charge : ${loadedVC.credentialSubject.degree} - ${loadedVC.credentialSubject.name}`;
                } catch(e) { alert("Fichier invalide"); }
            };
            reader.readAsText(e.target.files[0]);
        });

        async function createProof() {
            if(!loadedVC) return alert("Chargez le JSON d'abord !");
            
            try {
                const provider = new ethers.JsonRpcProvider("http://127.0.0.1:8545/", undefined, { staticNetwork: true });
                const signer = await provider.getSigner(10); 
                const contract = new ethers.Contract(contractAddress, abi, signer);

                const duration = document.getElementById("duration").value;
                
                // 1. Création du Token Blockchain (La Preuve Technique)
                const tx = await contract.createTempAccess(loadedVC.proof.hash, duration);
                const receipt = await tx.wait();

                let blockchainToken = null;
                for(const log of receipt.logs) {
                    try { 
                        const parsed = contract.interface.parseLog(log);
                        if(parsed.name === "AccessGranted") blockchainToken = parsed.args[0]; 
                    } catch(e){}
                }

                // 2. Création de la "Présentation" (Le Code Complet avec l'Identité)
                // On met le Nom + Diplome + Token Blockchain dans un paquet encodé
                const presentationData = {
                    token: blockchainToken,
                    name: loadedVC.credentialSubject.name,
                    degree: loadedVC.credentialSubject.degree
                };

                // Encodage en Base64 pour faire un seul bloc de texte facile à copier
                const presentationCode = btoa(JSON.stringify(presentationData));
                
                document.getElementById("resultArea").style.display = "block";
                document.getElementById("tempTokenDisplay").innerText = presentationCode;

            } catch(e) { 
                console.error(e); 
                alert("Erreur Blockchain : Verifiez que le diplome est valide."); 
            }
        }
    </script>
</body>
</html>