<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Espace √âtudiant</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f3e5f5; }
        .card { background: white; padding: 30px; border-radius: 12px; border-left: 6px solid #9c27b0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #9c27b0; text-align: center; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: #9c27b0; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #7b1fa2; }
        .result-box { margin-top: 20px; background: #fff; padding: 15px; border-radius: 5px; border: 1px dashed #9c27b0; display: none;}
        .nav { text-align: center; margin-bottom: 20px; }
        a { margin: 0 10px; text-decoration: none; color: #555; font-weight: bold; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
</head>
<body>
    <div class="nav">
        <a href="ecole.html"><- √âcole</a> | <strong>√âtudiant (Compte #2)</strong> | <a href="entreprise.html">Entreprise -></a>
    </div>

    <h1>üéì Mon Coffre-fort Dipl√¥me</h1>

    <div class="card">
        <h2>G√©n√©rer un lien de partage</h2>
        <p>Entrez votre <strong>Code Ma√Ætre</strong> (re√ßu de l'√©cole) pour cr√©er un acc√®s temporaire pour un recruteur.</p>
        
        <label>Votre Code Ma√Ætre :</label>
        <input type="text" id="masterCode" placeholder="Collez le code long (0x...)">
        
        <label>Dur√©e de validit√© :</label>
        <select id="duration">
            <option value="60">1 minute (Test rapide)</option>
            <option value="3600">1 Heure</option>
            <option value="86400">24 Heures</option>
            <option value="604800">1 Semaine</option>
        </select>
        
        <button onclick="generateTempLink()">‚è≥ Cr√©er un Code Temporaire</button>

        <div id="result" class="result-box"></div>
    </div>

    <script>
        // --- COLLE TON ADRESSE ICI ---
        const contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; 
        // -----------------------------

        const abi = [
            "function createTemporaryCode(bytes32, uint256) public returns (bytes32)",
            "event AccessTokenGenerated(bytes32 indexed tempCode, bytes32 indexed realCode, uint256 expiration)"
        ];

        async function generateTempLink() {
            const masterCode = document.getElementById("masterCode").value;
            const duration = document.getElementById("duration").value;
            const output = document.getElementById("result");

            if(!masterCode) return alert("Il faut le Code Ma√Ætre !");

            output.style.display = "block";
            output.innerText = "G√©n√©ration du code temporaire sur la Blockchain...";

            try {
                const provider = new ethers.JsonRpcProvider("http://127.0.0.1:8545/");
                // On utilise le Compte #2 pour simuler l'√©tudiant
                const signer = await provider.getSigner(2); 
                const contract = new ethers.Contract(contractAddress, abi, signer);

                const tx = await contract.createTemporaryCode(masterCode, duration);
                const receipt = await tx.wait();

                // R√©cup√©ration du log
                let tempCode = null;
                for (const log of receipt.logs) {
                    try {
                        const parsedLog = contract.interface.parseLog(log);
                        if (parsedLog.name === 'AccessTokenGenerated') {
                            tempCode = parsedLog.args[0];
                        }
                    } catch (e) {}
                }

                if(tempCode) {
                    output.innerHTML = `
                        <strong>‚úÖ Code Temporaire Cr√©√© !</strong><br>
                        Ce code est valide pour ${duration/60} minutes.<br><br>
                        <span style="color:#d63384; font-family:monospace; font-size:1.1em">${tempCode}</span>
                        <br><br>Donnez CE code au recruteur (gardez le ma√Ætre secret).
                    `;
                }

            } catch(err) {
                console.error(err);
                output.innerText = "Erreur : Code Ma√Ætre incorrect ou probl√®me r√©seau.";
            }
        }
    </script>
</body>
</html>